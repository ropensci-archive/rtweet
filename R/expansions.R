#' Expansions
#'
#' Twitter parameters to add more fields on the returned values.
#'
#' The `set_expansions` can be used to prepare the arguments for other rtweet functions.
#'
#' @param attachments Add attachments values? Default yes.
#' @param referenced_tweets Add referenced_tweets values? Default yes.
#' @param tweet,user [tweet_expansions()] and [user_expansions()].
#' @return A character with the characters of valid expansions.
#' @references <https://developer.twitter.com/en/docs/twitter-api/expansions>
#' @seealso [Fields], [set_fields()]
#' @name Expansions
#' @aliases expansions
#' @examples
#' tweet_expansions()
#' user_expansions()
#' set_expansions()
#' @export
set_expansions <- function(tweet = tweet_expansions(),
                           user = user_expansions()) {

  if (is.numeric(tweet)) {
    abort("Invalid tweet expansions.")
  }
  if (is.numeric(user)) {
    abort("Invalid user expansions.")
  }

  expansions <- c(tweet, user)

  check_expansions(expansions)
}

#' @export
#' @name Expansions
tweet_expansions <- function(attachments = TRUE, referenced_tweets = TRUE) {
  expansions <- c("author_id", "in_reply_to_user_id", "geo.place_id",
                  "entities.mentions.username",  "edit_history_tweet_ids")
  if (attachments) {
    expansions <- c(expansions, "attachments.media_keys",
                    "attachments.poll_ids")
  }
  if (referenced_tweets) {
    expansions <- c(expansions, "referenced_tweets.id", "referenced_tweets.id.author_id")
  }
  expansions
}

#' @export
#' @name Expansions
user_expansions <- function() {
  "pinned_tweet_id"
}

check_expansions <- function(passed, allowed = c(tweet_expansions(), user_expansions()),
                             call = caller_env()) {
  # Empty list or NA return NULL to disable the expansions
  empty_list <- is.list(passed) && length(passed) == 0
  na <- length(passed) == 1L && is.na(passed)
  if (is.null(passed) || empty_list || na) {
    return(NULL)
  }

  within <- !passed %in% allowed
  if (any(within)) {
    extensions <- passed[within]
    abort(paste0("These extensions are not allowed: ",
         paste(extensions, collapse = ", ")), call = call)
  }
  passed
}
